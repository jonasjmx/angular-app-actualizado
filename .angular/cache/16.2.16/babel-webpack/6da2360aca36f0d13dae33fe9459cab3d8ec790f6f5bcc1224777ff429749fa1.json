{"ast":null,"code":"import _asyncToGenerator from \"C:/Users/HP/Desktop/angular-app-actualizado/node_modules/@babel/runtime/helpers/esm/asyncToGenerator.js\";\nvar __decorate = this && this.__decorate || function (decorators, target, key, desc) {\n  var c = arguments.length,\n    r = c < 3 ? target : desc === null ? desc = Object.getOwnPropertyDescriptor(target, key) : desc,\n    d;\n  if (typeof Reflect === \"object\" && typeof Reflect.decorate === \"function\") r = Reflect.decorate(decorators, target, key, desc);else for (var i = decorators.length - 1; i >= 0; i--) if (d = decorators[i]) r = (c < 3 ? d(r) : c > 3 ? d(target, key, r) : d(target, key)) || r;\n  return c > 3 && r && Object.defineProperty(target, key, r), r;\n};\nvar __metadata = this && this.__metadata || function (k, v) {\n  if (typeof Reflect === \"object\" && typeof Reflect.metadata === \"function\") return Reflect.metadata(k, v);\n};\nimport { Component } from \"@angular/core\";\nimport { UserService } from \"../services/user.service\";\nexport let UsersComponent = class UsersComponent {\n  constructor(userSvc) {\n    this.userSvc = userSvc;\n    this.users = [];\n    this.roles = [];\n    this.loadingUsers = true;\n    this.loadingRoles = true;\n    // Alertbox superior para mensajes de éxito/error general\n    this.error = \"\";\n    this.success = \"\";\n    // Variables para el modal de error\n    this.isErrorModalOpen = false;\n    this.modalErrorMessage = \"\";\n    // Regex de Contraseña Segura\n    this.passwordPattern = /^(?=.*[a-z])(?=.*[A-Z])(?=.*\\d)(?=.*[$@$!%*?&])[A-Za-z\\d$@$!%*?&]{8,}$/;\n    // Pattern para validación final (NgModel)\n    this.namePattern = \"^[a-zA-ZáéíóúÁÉÍÓÚñÑ\\\\s]+$\";\n    // ----------- CREAR USUARIO (MODAL) -----------\n    this.isCreateModalOpen = false;\n    this.newUser = {\n      email: \"\",\n      password: \"\",\n      firstName: \"\",\n      lastName: \"\"\n    };\n    // ----------- EDITAR USUARIO (MODAL) -----------\n    this.isEditModalOpen = false;\n    this.editUserId = null;\n    this.editUser = {\n      firstName: \"\",\n      lastName: \"\",\n      phoneNumber: \"\",\n      emailConfirmed: false,\n      lockoutEnabled: false,\n      lockoutEnd: null\n    };\n    // Roles dentro del modal de edición\n    this.editUserRoles = [];\n    this.editCurrentRoleId = \"\";\n    this.editNewRoleId = \"\";\n    // ----------- ELIMINAR USUARIO (MODAL) -----------\n    this.isDeleteModalOpen = false;\n    this.userToDelete = null;\n    // ========== IMAGEN DE USUARIO ==========\n    this.currentUserImageSrc = null;\n    this.selectedImageBase64 = null;\n    this.hasUserImage = false;\n    this.loadingImage = false;\n    // ========== VALIDACIONES EXTRA ==========\n    this.phoneEditInvalid = false;\n  }\n  ngOnInit() {\n    var _this = this;\n    return _asyncToGenerator(function* () {\n      yield _this.loadUsers();\n      yield _this.loadRoles();\n    })();\n  }\n  // ------------ CARGAS INICIALES ------------\n  loadUsers() {\n    var _this2 = this;\n    return _asyncToGenerator(function* () {\n      _this2.loadingUsers = true;\n      try {\n        _this2.users = yield _this2.userSvc.getUsers();\n        // Cargar foto de cada usuario\n        for (let u of _this2.users) {\n          try {\n            const img = yield _this2.userSvc.getUserImage(u.id);\n            u.profileImage = img;\n          } catch {\n            u.profileImage = null;\n          }\n        }\n        _this2.loadingUsers = false;\n      } catch (err) {\n        console.error(err);\n        _this2.error = \"Error al cargar usuarios\";\n        _this2.loadingUsers = false;\n      }\n    })();\n  }\n  loadRoles() {\n    var _this3 = this;\n    return _asyncToGenerator(function* () {\n      try {\n        _this3.roles = yield _this3.userSvc.getRoles();\n        _this3.loadingRoles = false;\n      } catch (err) {\n        console.error(err);\n        _this3.error = \"Error al cargar roles\";\n        _this3.loadingRoles = false;\n      }\n    })();\n  }\n  // ============== MODAL DE ERROR GENÉRICO ==============\n  openErrorModal(message) {\n    this.modalErrorMessage = message;\n    this.isErrorModalOpen = true;\n  }\n  closeErrorModal() {\n    this.isErrorModalOpen = false;\n    this.modalErrorMessage = \"\";\n  }\n  // ============== VALIDACIÓN Y SANITIZACIÓN DE NOMBRES ==============\n  /**\n   * (input): Convierte a Mayúsculas y limpia si pegaron texto inválido.\n   */\n  sanitizeNameInput(obj, field) {\n    if (!obj[field]) return;\n    // Eliminar caracteres no permitidos (fallback para paste)\n    let val = obj[field].replace(/[^a-zA-ZáéíóúÁÉÍÓÚñÑ\\s]/g, '');\n    // Convertir a mayúsculas\n    obj[field] = val.toUpperCase();\n  }\n  /**\n   * (keydown): BLOQUEA la entrada de teclas no permitidas.\n   * Si la tecla no es letra o espacio, detiene el evento.\n   */\n  allowOnlyLetters(event) {\n    const key = event.key;\n    // 1. Permitir teclas de control (Backspace, Tab, Enter, Arrows, Delete)\n    // Estas teclas suelen tener nombres largos (ej: \"Backspace\")\n    if (key.length > 1) return;\n    // 2. Regex de lo permitido: Letras (a-z), mayúsculas, acentos, ñ y espacio.\n    const allowed = /^[a-zA-ZáéíóúÁÉÍÓÚñÑ\\s]$/;\n    // 3. Si la tecla presionada NO coincide con el regex, cancelamos la acción.\n    if (!allowed.test(key)) {\n      event.preventDefault();\n    }\n  }\n  // ============== CREAR USUARIO (MODAL) ==============\n  openCreateModal() {\n    this.error = \"\";\n    this.success = \"\";\n    this.newUser = {\n      email: \"\",\n      password: \"\",\n      firstName: \"\",\n      lastName: \"\"\n    };\n    this.isCreateModalOpen = true;\n  }\n  closeCreateModal() {\n    this.isCreateModalOpen = false;\n  }\n  register() {\n    var _this4 = this;\n    return _asyncToGenerator(function* () {\n      _this4.error = \"\";\n      _this4.success = \"\";\n      const email = _this4.newUser.email.trim();\n      const password = _this4.newUser.password;\n      const firstName = _this4.newUser.firstName.trim();\n      const lastName = _this4.newUser.lastName.trim();\n      // Validar duplicidad de correo\n      const emailExists = _this4.users.some(u => u.email.toLowerCase() === email.toLowerCase());\n      if (emailExists) {\n        _this4.openErrorModal(\"Ya existe un correo similar registrado en el sistema.\");\n        return;\n      }\n      // Validar complejidad de contraseña\n      if (!_this4.passwordPattern.test(password)) {\n        _this4.openErrorModal(\"La contraseña no cumple con los requisitos de seguridad.\");\n        return;\n      }\n      if (!firstName || !lastName) {\n        _this4.openErrorModal(\"Nombres y apellidos son obligatorios.\");\n        return;\n      }\n      try {\n        yield _this4.userSvc.registerUser({\n          email,\n          password,\n          firstName,\n          lastName\n        });\n        _this4.success = \"Usuario registrado correctamente\";\n        yield _this4.loadUsers();\n        _this4.closeCreateModal();\n      } catch (err) {\n        console.error(err);\n        _this4.openErrorModal(\"No se pudo registrar el usuario. Verifique los datos o intente más tarde.\");\n      }\n    })();\n  }\n  // ============== EDITAR USUARIO (MODAL) ==============\n  openEditModal(user) {\n    var _this5 = this;\n    return _asyncToGenerator(function* () {\n      _this5.editUserId = user.id;\n      _this5.editUser = {\n        firstName: user.firstName || \"\",\n        lastName: user.lastName || \"\",\n        phoneNumber: user.phoneNumber || \"\",\n        emailConfirmed: !!user.emailConfirmed,\n        lockoutEnabled: !!user.lockoutEnabled,\n        lockoutEnd: user.lockoutEnd || null\n      };\n      // Asegurar mayúsculas\n      _this5.sanitizeNameInput(_this5.editUser, 'firstName');\n      _this5.sanitizeNameInput(_this5.editUser, 'lastName');\n      _this5.editUserRoles = user.roles || [];\n      if (_this5.editUserRoles.length > 0) {\n        _this5.editCurrentRoleId = _this5.findRoleIdByName(_this5.editUserRoles[0]);\n      } else {\n        _this5.editCurrentRoleId = \"\";\n      }\n      _this5.editNewRoleId = \"\";\n      _this5.isEditModalOpen = true;\n      _this5.error = \"\";\n      _this5.success = \"\";\n      _this5.phoneEditInvalid = false;\n      // Cargar imagen\n      _this5.currentUserImageSrc = null;\n      _this5.selectedImageBase64 = null;\n      _this5.hasUserImage = false;\n      if (_this5.editUserId) {\n        yield _this5.loadUserImage(_this5.editUserId);\n      }\n    })();\n  }\n  closeEditModal() {\n    this.isEditModalOpen = false;\n    this.editUserId = null;\n    this.editUserRoles = [];\n    this.editCurrentRoleId = \"\";\n    this.editNewRoleId = \"\";\n    this.currentUserImageSrc = null;\n    this.selectedImageBase64 = null;\n    this.hasUserImage = false;\n    this.phoneEditInvalid = false;\n  }\n  saveEdit() {\n    var _this6 = this;\n    return _asyncToGenerator(function* () {\n      if (!_this6.editUserId) return;\n      _this6.error = \"\";\n      _this6.success = \"\";\n      const firstName = (_this6.editUser.firstName || \"\").trim();\n      const lastName = (_this6.editUser.lastName || \"\").trim();\n      const phone = (_this6.editUser.phoneNumber || \"\").trim();\n      if (!firstName || !lastName) {\n        _this6.openErrorModal(\"Nombres y apellidos son campos obligatorios.\");\n        return;\n      }\n      if (phone && !_this6.validatePhone(phone)) {\n        _this6.phoneEditInvalid = true;\n        _this6.openErrorModal(\"El número de teléfono no es válido (deben ser 10 dígitos).\");\n        return;\n      } else {\n        _this6.phoneEditInvalid = false;\n      }\n      _this6.editUser.firstName = firstName;\n      _this6.editUser.lastName = lastName;\n      _this6.editUser.phoneNumber = phone;\n      try {\n        yield _this6.userSvc.updateUser(_this6.editUserId, _this6.editUser);\n        _this6.success = \"Datos del usuario actualizados correctamente\";\n        yield _this6.loadUsers();\n      } catch (err) {\n        console.error(err);\n        _this6.error = \"No se pudieron actualizar los datos del usuario\";\n      }\n    })();\n  }\n  // ============== ROLES ==============\n  findRoleIdByName(name) {\n    const r = this.roles.find(x => x.name === name);\n    return r ? r.id : \"\";\n  }\n  changeRole() {\n    var _this7 = this;\n    return _asyncToGenerator(function* () {\n      if (!_this7.editUserId) return;\n      _this7.error = \"\";\n      _this7.success = \"\";\n      try {\n        if (_this7.editUserRoles.length === 0) {\n          if (!_this7.editNewRoleId) {\n            _this7.openErrorModal(\"Seleccione un rol para asignar.\");\n            return;\n          }\n          yield _this7.userSvc.assignRoleToUser(_this7.editUserId, _this7.editNewRoleId);\n        } else {\n          if (!_this7.editCurrentRoleId || !_this7.editNewRoleId) {\n            _this7.openErrorModal(\"Seleccione el rol actual y el nuevo rol.\");\n            return;\n          }\n          yield _this7.userSvc.updateUserRole(_this7.editUserId, _this7.editCurrentRoleId, _this7.editNewRoleId);\n        }\n        _this7.success = \"Rol actualizado correctamente.\";\n        yield _this7.loadUsers();\n        _this7.refreshRolesLocalData();\n      } catch (err) {\n        console.error(err);\n        _this7.error = \"No se pudo actualizar el rol del usuario.\";\n      }\n    })();\n  }\n  removeRole() {\n    var _this8 = this;\n    return _asyncToGenerator(function* () {\n      if (!_this8.editUserId || !_this8.editCurrentRoleId) {\n        _this8.openErrorModal(\"Seleccione un rol a eliminar.\");\n        return;\n      }\n      _this8.error = \"\";\n      _this8.success = \"\";\n      try {\n        yield _this8.userSvc.removeUserRole(_this8.editUserId, _this8.editCurrentRoleId);\n        _this8.success = \"Rol eliminado del usuario.\";\n        yield _this8.loadUsers();\n        _this8.refreshRolesLocalData();\n      } catch (err) {\n        console.error(err);\n        _this8.error = \"No se pudo quitar el rol del usuario.\";\n      }\n    })();\n  }\n  refreshRolesLocalData() {\n    const updated = this.users.find(u => u.id === this.editUserId);\n    this.editUserRoles = updated?.roles || [];\n    if (this.editUserRoles.length > 0) {\n      this.editCurrentRoleId = this.findRoleIdByName(this.editUserRoles[0]);\n    } else {\n      this.editCurrentRoleId = \"\";\n    }\n    this.editNewRoleId = \"\";\n  }\n  // ============== ELIMINAR USUARIO ==============\n  openDeleteModal(user) {\n    this.userToDelete = user;\n    this.isDeleteModalOpen = true;\n    this.error = \"\";\n    this.success = \"\";\n  }\n  closeDeleteModal() {\n    this.isDeleteModalOpen = false;\n    this.userToDelete = null;\n  }\n  confirmDelete() {\n    var _this9 = this;\n    return _asyncToGenerator(function* () {\n      if (!_this9.userToDelete) return;\n      _this9.error = \"\";\n      _this9.success = \"\";\n      try {\n        yield _this9.userSvc.deleteUser(_this9.userToDelete.id);\n        _this9.success = \"Usuario eliminado correctamente\";\n        yield _this9.loadUsers();\n        _this9.closeDeleteModal();\n      } catch (err) {\n        console.error(err);\n        _this9.error = \"No se pudo eliminar el usuario\";\n        _this9.closeDeleteModal();\n      }\n    })();\n  }\n  // ============== IMAGEN DE USUARIO ==============\n  loadUserImage(userId) {\n    var _this0 = this;\n    return _asyncToGenerator(function* () {\n      _this0.loadingImage = true;\n      try {\n        const base64 = yield _this0.userSvc.getUserImage(userId);\n        if (base64) {\n          _this0.currentUserImageSrc = `data:image/jpeg;base64,${base64}`;\n          _this0.hasUserImage = true;\n        } else {\n          _this0.currentUserImageSrc = null;\n          _this0.hasUserImage = false;\n        }\n      } catch (err) {\n        console.error(err);\n      } finally {\n        _this0.loadingImage = false;\n      }\n    })();\n  }\n  onImageSelected(event) {\n    const file = event.target.files?.[0];\n    if (!file) return;\n    if (!file.type.startsWith(\"image/\")) {\n      this.error = \"El archivo seleccionado no es una imagen.\";\n      return;\n    }\n    const reader = new FileReader();\n    reader.onload = () => {\n      const result = reader.result;\n      const base64 = result.split(\",\")[1];\n      this.selectedImageBase64 = base64;\n      this.currentUserImageSrc = result;\n    };\n    reader.readAsDataURL(file);\n  }\n  saveUserImage() {\n    var _this1 = this;\n    return _asyncToGenerator(function* () {\n      if (!_this1.editUserId) return;\n      _this1.error = \"\";\n      _this1.success = \"\";\n      if (!_this1.selectedImageBase64) {\n        _this1.openErrorModal(\"Seleccione una imagen antes de guardar.\");\n        return;\n      }\n      try {\n        if (_this1.hasUserImage) {\n          yield _this1.userSvc.updateUserImage(_this1.editUserId, _this1.selectedImageBase64);\n        } else {\n          yield _this1.userSvc.createUserImage(_this1.editUserId, _this1.selectedImageBase64);\n        }\n        _this1.hasUserImage = true;\n        _this1.success = \"Imagen de usuario guardada correctamente.\";\n        yield _this1.loadUsers();\n      } catch (err) {\n        console.error(err);\n        _this1.error = \"No se pudo guardar la imagen del usuario.\";\n      }\n    })();\n  }\n  deleteUserImage() {\n    var _this10 = this;\n    return _asyncToGenerator(function* () {\n      if (!_this10.editUserId) return;\n      const ok = confirm(\"¿Seguro que deseas eliminar la imagen de este usuario?\");\n      if (!ok) return;\n      _this10.error = \"\";\n      _this10.success = \"\";\n      try {\n        yield _this10.userSvc.deleteUserImage(_this10.editUserId);\n        _this10.currentUserImageSrc = null;\n        _this10.selectedImageBase64 = null;\n        _this10.hasUserImage = false;\n        _this10.success = \"Imagen eliminada correctamente.\";\n        yield _this10.loadUsers();\n      } catch (err) {\n        console.error(err);\n        _this10.error = \"No se pudo eliminar la imagen del usuario.\";\n      }\n    })();\n  }\n  // ============== VALIDACIONES EXTRA HELPER ==============\n  validatePhone(phone) {\n    if (!phone) return false;\n    return /^[0-9]{10}$/.test(phone);\n  }\n  /**\n   * Bloquea entrada de letras en campo teléfono\n   */\n  allowOnlyNumbers(event) {\n    const key = event.key;\n    if (key.length > 1) return;\n    if (!/^[0-9]$/.test(key)) {\n      event.preventDefault();\n    }\n  }\n};\nUsersComponent = __decorate([Component({\n  selector: \"app-users\",\n  templateUrl: \"./users.component.html\",\n  styleUrls: [\"./users.component.css\"]\n}), __metadata(\"design:paramtypes\", [UserService])], UsersComponent);","map":null,"metadata":{},"sourceType":"module","externalDependencies":[]}